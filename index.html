<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Inventori Barang</title>
  <style>
    /* === Gaya Umum === */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #e8f9fd;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background: #00a8cc;
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    main {
      width: 95%;
      max-width: 1000px;
      margin: 15px auto;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    h2 {
      color: #007b9e;
      border-bottom: 2px solid #00a8cc;
      padding-bottom: 5px;
      font-size: 18px;
    }
    
    .form-container {
      background: #fdfdfd;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }
    .form-container button {
        margin-top: 10px;
    }

    /* === Elemen Form === */
    input, button, select {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #aaa;
      border-radius: 5px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="file"] {
      padding: 5px;
      background: #f4f4f4;
    }

    button {
      background: #00a8cc;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background: #007b9e; }
    
    a.button {
        display: block;
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
        text-decoration: none;
        text-align: center;
        color: white;
    }
    
    .button-impor { background: #008c4a; }
    .button-impor:hover { background: #006b39; }
    
    .button-pendapatan { background: #f0a500; }
    .button-pendapatan:hover { background: #c28400; }

    .button-logout { background: #ff5252; }
    .button-logout:hover { background: #d42c2c; }

    /* === [CSS BARU] Tombol Aksi di Tabel === */
    .actions button {
      margin: 2px 0;
      width: 100%;
    }
    .button-jual { background-color: #4CAF50; } /* Hijau */
    .button-jual:hover { background-color: #388E3C; }
    .button-edit { background-color: #00a8cc; } /* Biru (default) */
    .button-edit:hover { background-color: #007b9e; }
    .button-hapus { background-color: #e64a19; } /* Merah */
    .button-hapus:hover { background-color: #c33000; }
    

    /* === Login === */
    #login-container {
      width: 90%;
      max-width: 350px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      padding: 25px;
      margin: 80px auto;
      text-align: center;
    }
    
    /* === Tabel === */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td { border: 1px solid #ccc; text-align: center; padding: 8px; }
    th { background: #00a8cc; color: white; }
    tr.low-stock { background: #ffe0e0; font-weight: bold; }

    /* === Tombol Stok +/- === */
    .stok-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        white-space: nowrap; 
    }
    .stok-value {
        font-weight: bold;
        min-width: 30px;
    }
    .stok-btn {
        width: 28px;
        height: 28px;
        font-size: 16px;
        font-weight: bold;
        padding: 0;
        line-height: 28px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .stok-btn.minus { background-color: #e64a19; }
    .stok-btn.minus:hover { background-color: #c33000; }
    .stok-btn.plus { background-color: #4CAF50; }
    .stok-btn.plus:hover { background-color: #388E3C; }

    /* === Responsif untuk HP === */
    @media (max-width: 768px) {
      header { font-size: 18px; }
      .filter-container { flex-direction: column; align-items: stretch; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { display: none; }
      tbody tr { margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd; padding: 10px; }
      tbody td { text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
      tbody td::before { content: attr(data-label); position: absolute; left: 10px; width: 45%; text-align: left; font-weight: bold; color: #007b9e; }
      
      /* [PERUBAHAN CSS] Tombol aksi di mobile */
      .actions button {
        width: 100%; /* Jadi 100% agar rapi */
        display: block; /* Menumpuk ke bawah */
        margin-bottom: 5px; /* Jarak antar tombol */
      }
      
      tbody td[data-label="Stok"] {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      tbody td[data-label="Stok"]::before {
        position: relative;
        left: 0;
        width: auto;
      }
      .stok-controls {
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>

  <header>üì¶ Sistem Inventori & Pendapatan üì¶</header>

  <div id="login-container">
    <h2>Login Admin</h2>
    <input type="text" id="username" placeholder="Username">
    <div id="password-container">
      <input type="password" id="password" placeholder="Password">
      <span class="show-password" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
    <button onclick="login()">Masuk</button>
    <p id="error-msg"></p>
  </div>

  <main id="inventori-container" style="display: none;">
    <h2>Daftar Inventori Barang</h2>
    
    <a href="pendapatan.html" class="button button-pendapatan" style="width:100%;">
      üìä Lihat Laporan Pendapatan
    </a>

    <div class="filter-container" style="margin-top: 15px;">
      <input type="text" id="search" placeholder="Cari barang..." onkeyup="tampilkanInventori()">
      <select id="sort-option" onchange="tampilkanInventori()">
        <option value="">Urutkan...</option>
        <option value="nama">Nama (A - Z)</option>
        <option value="nama-desc">Nama (Z - A)</option>
        <option value="harga">Harga (Termurah)</option>
        <option value="harga-desc">Harga (Termahal)</option>
        <option value="stok">Stok (Tersedikit)</option>
      </select>
      <button onclick="cetakLaporan()">üñ®Ô∏è Cetak Laporan</button>
    </div>

    <table id="tabel-barang">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nama</th>
          <th>Jenis</th>
          <th>Koreksi Stok</th> <th>Harga</th>
          <th>Update</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="form-container">
        <h2>Tambah / Update Barang</h2>
        <p style="font-size: 13px; color: #555;">
          Gunakan form ini untuk menambah barang baru atau mengedit data.
          Untuk mencatat penjualan, gunakan tombol <strong>"Terjual"</strong> di tabel.
        </p>
        <input type="text" id="id" placeholder="ID Barang (A001)">
        <input type="text" id="nama" placeholder="Nama Barang">
        <input type="text" id="jenis" placeholder="Jenis Barang">
        <input type="number" id="stok" placeholder="Stok">
        <input type="number" id="harga" placeholder="Harga">
        <button onclick="tambahAtauUpdateBarang()">Simpan</button>
    </div>

    <div class="form-container">
        <h2>Impor dari CSV</h2>
        <input type="file" id="csv-file" accept=".csv">
        <button onclick="imporCSV()" class="button-impor">Impor Data CSV</button>
    </div>

    <button onclick="logout()" class="button-logout" style="width:100%; margin-top: 15px;">Logout</button>
  </main>

  <script>
    const USERNAME = "admin";
    const PASSWORD = "iwan123";
    
    // Data Inisialisasi
    let inventoriBarang = ambilDariLocalStorage("inventoriBarang");
    let riwayatPenjualan = ambilDariLocalStorage("riwayatPenjualan");
    
    // ======================
    // FUNGSI NAVIGASI & LOGIN
    // ======================

    function togglePassword() {
      const pass = document.getElementById("password");
      pass.type = pass.type === "password" ? "text" : "password";
    }

    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      const errorMsg = document.getElementById("error-msg");

      if (user === USERNAME && pass === PASSWORD) {
        localStorage.setItem("isLoggedIn", "true");
        tampilkanHalamanInventori();
        
        tampilkanInventori();
        mintaIzinNotifikasi();
        cekStokHabis();
      } else {
        errorMsg.textContent = "‚ùå Username atau password salah!";
      }
    }

    function logout() {
      if (confirm("Yakin ingin logout?")) {
        localStorage.removeItem("isLoggedIn");
        document.getElementById("inventori-container").style.display = "none";
        document.getElementById("login-container").style.display = "block";
      }
    }

    function tampilkanHalamanInventori() {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("inventori-container").style.display = "block";
    }
    
function cetakLaporan() {
    const backup = document.body.innerHTML;
    
    // Ambil tabel inventori saja
    const tabel = document.getElementById("tabel-barang").outerHTML;

    // Template tampilan cetak
    const laporanHTML = `
        <html>
        <head>
            <title>Laporan Inventori</title>
            <style>
                body { font-family: Arial; padding: 20px; }
                h2 { text-align: center; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #000; padding: 6px; text-align: center; }
                th { background: #ddd; }
            </style>
        </head>
        <body>
            <h2>Laporan Inventori Barang</h2>
            ${tabel}
        </body>
        </html>
    `;

    // Tampilkan halaman untuk dicetak
    document.body.innerHTML = laporanHTML;
    window.print();

    // Kembalikan tampilan seperti semula
    document.body.innerHTML = backup;
    location.reload();
}

    // ======================
    // FUNGSI LOCAL STORAGE
    // ======================
    
    function simpanKeLocalStorage(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function ambilDariLocalStorage(key) {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    }

    // ======================
    // FUNGSI INVENTORI
    // ======================

    function tampilkanInventori() {
      const tbody = document.querySelector("#tabel-barang tbody");
      const search = document.getElementById("search").value.toLowerCase();
      const sort = document.getElementById("sort-option").value;

      let dataTampil = inventoriBarang.filter(b => 
        b.nama.toLowerCase().includes(search) ||
        b.jenis.toLowerCase().includes(search) ||
        b.id.toLowerCase().includes(search)
      );

      // (Logika sorting tidak berubah)
      if (sort === "nama") dataTampil.sort((a, b) => a.nama.localeCompare(b.nama));
      else if (sort === "nama-desc") dataTampil.sort((a, b) => b.nama.localeCompare(a.nama));
      else if (sort === "harga") dataTampil.sort((a, b) => a.harga - b.harga);
      else if (sort === "harga-desc") dataTampil.sort((a, b) => b.harga - a.harga);
      else if (sort === "stok") dataTampil.sort((a, b) => a.stok - b.stok);

      tbody.innerHTML = "";
      dataTampil.forEach(b => {
        const row = document.createElement("tr");
        if (b.stok <= 5) row.classList.add("low-stock");
        
        // === [PERUBAHAN HTML DI SINI] ===
        row.innerHTML = `
          <td data-label="ID">${b.id}</td>
          <td data-label="Nama">${b.nama}</td>
          <td data-label="Jenis">${b.jenis}</td>
          <td data-label="Koreksi Stok">
            <div class="stok-controls">
              <button class="stok-btn minus" onclick="ubahStok('${b.id}', -1)">-</button>
              <span class="stok-value">${b.stok}</span>
              <button class="stok-btn plus" onclick="ubahStok('${b.id}', 1)">+</button>
            </div>
          </td>
          <td data-label="Harga">${b.harga.toLocaleString("id-ID")}</td>
          <td data-label="Update">${b.updateTerakhir || "-"}</td>
          <td data-label="Aksi" class="actions">
            <button class="button-jual" onclick="jualBarang('${b.id}')">üõí Terjual</button>
            <button class="button-edit" onclick="editBarang('${b.id}')">Edit</button>
            <button class="button-hapus" onclick="hapusBarang('${b.id}')">Hapus</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    // === [PERUBAHAN JAVASCRIPT: ubahStok] ===
    // Fungsi ini sekarang HANYA mengubah stok, TIDAK mencatat penjualan
    function ubahStok(id, jumlah) {
        const index = inventoriBarang.findIndex(b => b.id === id);
        if (index === -1) return;

        const barang = inventoriBarang[index];
        const stokBaru = barang.stok + jumlah;

        if (stokBaru < 0) {
            alert("Stok tidak boleh minus!");
            return;
        }
        
        // Update stok di array
        barang.stok = stokBaru;
        barang.updateTerakhir = new Date().toLocaleString("id-ID");

        // === Logika Penjualan DIHAPUS DARI SINI ===

        // Simpan & refresh UI
        simpanKeLocalStorage("inventoriBarang", inventoriBarang);
        tampilkanInventori();
        cekStokHabis();
    }
    
    // === [FUNGSI JAVASCRIPT BARU: jualBarang] ===
    // Fungsi ini khusus untuk mencatat penjualan
    function jualBarang(id) {
        const index = inventoriBarang.findIndex(b => b.id === id);
        if (index === -1) return;
        
        const barang = inventoriBarang[index];

        const jumlahJualStr = prompt(`Berapa ${barang.nama} yang terjual?\nStok saat ini: ${barang.stok}`);
        
        // Jika user klik "Cancel"
        if (jumlahJualStr === null) return; 
        
        const jumlahJual = parseInt(jumlahJualStr);

        // Validasi input
        if (isNaN(jumlahJual) || jumlahJual <= 0) {
            alert("Jumlah tidak valid.");
            return;
        }
        
        if (jumlahJual > barang.stok) {
            alert(`Stok tidak mencukupi! Stok ${barang.nama} hanya tersisa ${barang.stok}.`);
            return;
        }
        
        // ---- Proses Penjualan ----
        
        // 1. Kurangi stok
        barang.stok = barang.stok - jumlahJual;
        barang.updateTerakhir = new Date().toLocaleString("id-ID");
        
        // 2. Catat di riwayat penjualan
        const totalPendapatan = jumlahJual * barang.harga;
        const isoTanggal = new Date().toISOString();

        riwayatPenjualan.push({
            id: barang.id,
            nama: barang.nama,
            jumlah: jumlahJual,
            hargaJual: barang.harga,
            total: totalPendapatan,
            tanggal: isoTanggal 
        });
        
        // 3. Simpan kedua data
        simpanKeLocalStorage("inventoriBarang", inventoriBarang);
        simpanKeLocalStorage("riwayatPenjualan", riwayatPenjualan);
        
        // 4. Refresh UI
        tampilkanInventori();
        cekStokHabis();
        alert(`Berhasil terjual ${jumlahJual} ${barang.nama}.`);
    }

    // === [PERUBAHAN JAVASCRIPT: tambahAtauUpdateBarang] ===
    // Logika penjualan DIHAPUS dari fungsi ini
    function tambahAtauUpdateBarang() {
      const id = document.getElementById("id").value.trim().toUpperCase();
      const nama = document.getElementById("nama").value.trim();
      const jenis = document.getElementById("jenis").value.trim();
      const stokBaru = parseInt(document.getElementById("stok").value);
      const harga = parseInt(document.getElementById("harga").value);

      if (!id || !nama || !jenis || isNaN(stokBaru) || isNaN(harga)) {
        alert("‚ö†Ô∏è Mohon isi semua data dengan benar!");
        return;
      }

      const tanggal = new Date().toLocaleString("id-ID");
      const index = inventoriBarang.findIndex(b => b.id === id);

      // === Logika Penjualan DIHAPUS DARI SINI ===

      // SIMPAN INVENTORI
      if (index !== -1) {
          inventoriBarang[index] = { id, nama, jenis, stok: stokBaru, harga, updateTerakhir: tanggal };
      } else {
          inventoriBarang.push({ id, nama, jenis, stok: stokBaru, harga, updateTerakhir: tanggal });
      }

      simpanKeLocalStorage("inventoriBarang", inventoriBarang);
      tampilkanInventori();
      cekStokHabis();
      
      document.getElementById("id").value = "";
      document.getElementById("nama").value = "";
      document.getElementById("jenis").value = "";
      document.getElementById("stok").value = "";
      document.getElementById("harga").value = "";
    }

    function editBarang(id) {
      // (Fungsi tidak berubah)
      const b = inventoriBarang.find(b => b.id === id);
      if (!b) return;
      document.getElementById("id").value = b.id;
      document.getElementById("nama").value = b.nama;
      document.getElementById("jenis").value = b.jenis;
      document.getElementById("stok").value = b.stok;
      document.getElementById("harga").value = b.harga;
      window.scrollTo(0, document.body.scrollHeight);
    }

    function hapusBarang(id) {
      // (Fungsi tidak berubah)
      if (confirm(`Yakin hapus barang dengan ID ${id}?`)) {
        inventoriBarang = inventoriBarang.filter(b => b.id !== id);
        simpanKeLocalStorage("inventoriBarang", inventoriBarang);
        tampilkanInventori();
        cekStokHabis();
      }
    }
    
    function imporCSV() {
      // (Fungsi tidak berubah)
      const fileInput = document.getElementById('csv-file');
      const file = fileInput.files[0];
      if (!file) { alert("Pilih file CSV."); return; }
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const text = event.target.result;
          const lines = text.split('\n').filter(line => line.trim() !== '');
          if (lines.length <= 1) { alert("File CSV kosong."); return; }
          let imporBerhasil = 0;
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            if (values.length < 5) continue;
            const [id, nama, jenis, stok, harga] = values.map(v => v.trim());
            const stokInt = parseInt(stok);
            const hargaInt = parseInt(harga);
            if (!id || !nama || !jenis || isNaN(stokInt) || isNaN(hargaInt)) continue;
            
            const tanggal = new Date().toLocaleString("id-ID");
            const index = inventoriBarang.findIndex(b => b.id === id.toUpperCase());
            const dataBaru = { id: id.toUpperCase(), nama, jenis, stok: stokInt, harga: hargaInt, updateTerakhir: tanggal };

            if (index !== -1) inventoriBarang[index] = dataBaru;
            else inventoriBarang.push(dataBaru);
            imporBerhasil++;
          }
          simpanKeLocalStorage("inventoriBarang", inventoriBarang);
          tampilkanInventori();
          cekStokHabis();
          alert(`Impor Selesai! Berhasil: ${imporBerhasil}`);
        } catch (err) { alert("Gagal proses file."); }
      };
      reader.readAsText(file);
    }

    // ======================
    // FUNGSI NOTIFIKASI
    // ======================
    function mintaIzinNotifikasi() {
      // (Fungsi tidak berubah)
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    function cekStokHabis() {
      // (Fungsi tidak berubah)
      const barangHabis = inventoriBarang.filter(b => b.stok <= 5);
      if (barangHabis.length === 0) return;
      const namaBarang = barangHabis.map(b => b.nama).join(', ');
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification("‚ö†Ô∏è Stok Menipis!", {
          body: `Segera restock: ${namaBarang}`,
          tag: "stok-menipis"
        });
      }
    }
    
    // ======================
    // FUNGSI INISIASI (LOAD)
    // ======================
    
    if (localStorage.getItem("isLoggedIn") === "true") {
      // (Fungsi tidak berubah)
      tampilkanHalamanInventori();
      tampilkanInventori();
      mintaIzinNotifikasi();
      cekStokHabis();
    }
  </script>
</body>
</html>